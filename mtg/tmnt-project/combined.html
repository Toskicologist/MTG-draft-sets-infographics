<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMNT - Draft Analytics: Archetypes & Ratings</title>
    <meta property="og:title" content="TMNT Draft Analytics">
    <meta property="og:description" content="Teenage Mutant Ninja Turtles (TMT) limited format: color wheel archetypes + triple-source normalized card ratings.">
    <meta property="og:type" content="website">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/mana-font@latest/css/mana.min.css" rel="stylesheet" type="text/css" />
    <!--
    TMNT Draft Analytics Combined Page (v1.0.0)
    Color wheel (v1.0.4) + Normalized ratings table (v3.0.0)
    Created 2026-03-01
    -->
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #1a472a 0%, #2d6a4f 100%);
            color: #333;
            min-height: 100vh;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px;
        }

        /* ‚îÄ‚îÄ Color Wheel Section ‚îÄ‚îÄ */
        .wheel-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .wheel-header {
            text-align: center;
            margin-bottom: 16px;
        }

        .wheel-header h1 {
            font-size: 1.8rem;
            color: #1a472a;
            margin-bottom: 4px;
        }

        .wheel-header p {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 8px;
        }

        #color-wheel-root {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        /* ‚îÄ‚îÄ Ratings Section ‚îÄ‚îÄ */
        .ratings-section {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .ratings-header {
            background: linear-gradient(135deg, #1a472a 0%, #2d6a4f 50%, #52b788 100%);
            color: white;
            padding: 28px 30px;
            text-align: center;
        }

        .ratings-header h2 {
            font-size: 1.6rem;
            margin-bottom: 6px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }

        .ratings-header p {
            font-size: 0.9rem;
            opacity: 0.92;
            margin-bottom: 4px;
        }

        .info-banner {
            background: #f0fff4;
            padding: 12px 24px;
            border-bottom: 2px solid #2d6a4f;
            font-size: 0.88em;
            color: #444;
            line-height: 1.6;
        }

        .info-banner strong { color: #1a472a; }
        .info-banner a { color: #2d6a4f; }

        .warning-banner {
            background: #fff8e1;
            border-bottom: 2px solid #f59e0b;
            padding: 8px 24px;
            font-size: 0.85em;
            color: #78350f;
        }

        .controls {
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 0.82em;
        }

        .filter-group { display: flex; gap: 5px; align-items: center; }
        .filter-group label { font-weight: 600; color: #333; }

        select, input[type="text"] {
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.88em;
            background: white;
        }

        select:hover, input[type="text"]:hover { border-color: #2d6a4f; }

        .separator { width: 1px; height: 22px; background: #ccc; margin: 0 3px; }

        .color-btn, .rarity-btn {
            padding: 2px 8px;
            border-radius: 3px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 0.78em;
            font-weight: 700;
            transition: all 0.12s;
        }

        .color-btn.active, .rarity-btn.active { border-color: #333 !important; }

        .table-wrapper { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.83em;
        }

        th {
            background: #2d6a4f;
            color: white;
            padding: 7px 8px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            z-index: 2;
        }

        th.name-col { text-align: left; }
        th:hover { background: #1a472a; }
        th .sort-indicator { margin-left: 3px; opacity: 0.4; font-size: 0.8em; }
        th.sorted-asc .sort-indicator::after { content: '‚ñ≤'; opacity: 1; }
        th.sorted-desc .sort-indicator::after { content: '‚ñº'; opacity: 1; }
        th .sort-indicator::after { content: '‚Üï'; opacity: 0.4; }

        td {
            padding: 4px 8px;
            border-bottom: 1px solid #eee;
            text-align: center;
            vertical-align: middle;
        }

        td.name-col { text-align: left; }
        tr:hover { background: #f0fff4 !important; }
        tr:nth-child(even) { background: #fafcfb; }

        .norm-bar-cell { min-width: 90px; }
        .norm-bar-wrap { display: flex; align-items: center; gap: 4px; }
        .norm-bar-bg { flex: 1; height: 10px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
        .norm-bar-fill { height: 100%; border-radius: 3px; transition: width 0.2s; }
        .norm-val { font-size: 0.8em; font-weight: 700; min-width: 34px; text-align: right; }

        .color-W { background: #f5f5dc; color: #333; border: 1px solid #ccc; }
        .color-U { background: #1a56db; color: white; }
        .color-B { background: #1a1a2e; color: white; }
        .color-R { background: #dc2626; color: white; }
        .color-G { background: #16a34a; color: white; }
        .color-M { background: linear-gradient(135deg, #d97706, #7c3aed); color: white; }
        .color-C { background: #6b7280; color: white; }
        .color-L { background: #92400e; color: white; }
        .color-badge { display: inline-block; padding: 1px 5px; border-radius: 2px; font-size: 0.78em; font-weight: 600; }

        .rarity-C { color: #4b5563; font-weight: 600; }
        .rarity-U { color: #1d4ed8; font-weight: 600; }
        .rarity-R { color: #b45309; font-weight: 600; }
        .rarity-M { color: #7c3aed; font-weight: 600; }

        .cgb-Aplus, .cgb-A, .cgb-Aminus { color: #166534; font-weight: 700; }
        .cgb-Bplus, .cgb-B, .cgb-Bminus { color: #854d0e; font-weight: 700; }
        .cgb-Cplus, .cgb-C, .cgb-Cminus { color: #9a3412; font-weight: 700; }
        .cgb-Dplus, .cgb-D, .cgb-Dminus { color: #6d28d9; font-weight: 700; }
        .cgb-F { color: #6b7280; font-weight: 700; }

        td.col-cgb { background: rgba(16,185,129,0.07); }
        td.col-ds { background: rgba(37,99,235,0.07); }
        td.col-maz { background: rgba(168,85,247,0.07); }
        td.col-avg { background: rgba(245,158,11,0.1); }
        td.col-controversy { background: rgba(239,68,68,0.06); }

        .ds-score, .maz-score { font-weight: 700; }
        .name-link { color: #1a472a; text-decoration: none; font-weight: 600; }
        .name-link:hover { text-decoration: underline; }
        .missing { color: #9ca3af; font-style: italic; font-size: 0.8em; }

        .type-cell { font-size: 0.78em; color: #555; text-align: left; max-width: 110px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .mana-cell { font-size: 0.78em; color: #333; white-space: nowrap; }

        .card-tooltip {
            position: fixed;
            display: none;
            background: white;
            border: 2px solid #2d6a4f;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.35);
            z-index: 10000;
            padding: 6px;
            pointer-events: none;
            max-width: 230px;
        }

        .card-tooltip img { width: 220px; height: auto; border-radius: 4px; display: block; }

        .card-image { display: none; margin-top: 6px; }
        .card-image img { width: 180px; height: auto; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: block; }
        body.show-images .card-image { display: block; }

        .controversy-low { color: #16a34a; font-weight: 700; }
        .controversy-mid { color: #d97706; font-weight: 700; }
        .controversy-high { color: #dc2626; font-weight: 700; }

        .stats-bar { padding: 8px 20px; background: #f0fff4; border-top: 1px solid #ddd; font-size: 0.82em; color: #555; }
        .no-results { text-align: center; padding: 40px; color: #888; }

        @media (max-width: 768px) {
            .main-container { padding: 8px; }
            .wheel-section { padding: 12px; margin-bottom: 16px; }
            .controls { font-size: 0.75em; gap: 6px; }
            table { font-size: 0.75em; }
            th, td { padding: 3px 6px; }
            .color-wheel-svg { max-height: none !important; max-width: 100% !important; width: 100% !important; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Color Wheel -->
        <div class="wheel-section">
            <div class="wheel-header">
                <h1>üê¢ TMNT Draft Archetypes</h1>
                <p><strong>Teenage Mutant Ninja Turtles (TMT)</strong> Limited Format ¬∑ 5 Enemy-Color-Pair Archetypes</p>
                <p style="font-size: 0.85rem; color: #888;">
                    Sources: <a href="https://cardgamebase.com/tmnt-draft-tier-list/" target="_blank" rel="noopener noreferrer" style="color: #2d6a4f;">CardGameBase</a> ¬∑
                    <a href="https://draftsim.com/mtg-tmt-limited-set-review/" target="_blank" rel="noopener noreferrer" style="color: #2d6a4f;">Draftsim</a> ¬∑
                    <a href="https://scryfall.com/search?q=e%3Atmt" target="_blank" rel="noopener noreferrer" style="color: #2d6a4f;">Scryfall</a>
                </p>
            </div>
            <div id="color-wheel-root"></div>
        </div>

        <!-- Ratings Table -->
        <div class="ratings-section">
            <div class="ratings-header">
                <h2>Card Ratings & Analysis</h2>
                <p>Teenage Mutant Ninja Turtles (TMT) ¬∑ Z-Score Normalized Expert Ratings</p>
                <p style="font-size: 0.85rem; opacity: 0.9;">Three sources: CardGameBase + Draftsim + MTG Arena Zone</p>
            </div>

            <div class="warning-banner">
                ‚ö†Ô∏è <strong>Pre-release data only.</strong> 17Lands play-data will be available ~1 week after March 6, 2026.
            </div>

            <div class="info-banner">
                <strong>How this works:</strong> Each source independently z-score normalized (mean=0, SD=1).
                <strong>Three sources:</strong> (1) CardGameBase letter grades ‚Üí 0‚Äì10 scale; (2) Draftsim 0‚Äì10; (3) MTG Arena Zone 0‚Äì10 limited format.
                <strong>Avg Z</strong> = mean of all available z-scores (2 or 3 sources). <strong>Spread</strong> = max z-score difference.
                <strong>Sources</strong> shown in Avg Z cell: (3-src), (2-src), or (1-src).
            </div>

            <div class="controls">
                <div class="filter-group">
                    <label>Search:</label>
                    <input type="text" id="searchInput" placeholder="Card name..." style="width:160px" oninput="applyFilters()">
                </div>
                <div class="separator"></div>
                <div class="filter-group">
                    <label>Color:</label>
                    <button class="color-btn active" data-color="W" onclick="toggleColor(this)" style="background:#f5f5dc;color:#333;border:1px solid #aaa;">W</button>
                    <button class="color-btn active" data-color="U" onclick="toggleColor(this)" style="background:#1a56db;color:white;">U</button>
                    <button class="color-btn active" data-color="B" onclick="toggleColor(this)" style="background:#1a1a2e;color:white;">B</button>
                    <button class="color-btn active" data-color="R" onclick="toggleColor(this)" style="background:#dc2626;color:white;">R</button>
                    <button class="color-btn active" data-color="G" onclick="toggleColor(this)" style="background:#16a34a;color:white;">G</button>
                    <button class="color-btn active" data-color="M" onclick="toggleColor(this)" style="background:#d97706;color:white;">Multi</button>
                    <button class="color-btn active" data-color="C" onclick="toggleColor(this)" style="background:#6b7280;color:white;">Art</button>
                    <button class="color-btn active" data-color="L" onclick="toggleColor(this)" style="background:#92400e;color:white;">Land</button>
                    <button onclick="allColors(true)" style="padding:2px 6px;border:1px solid #bbb;border-radius:3px;background:#fff;font-size:0.75em;cursor:pointer;">All</button>
                    <button onclick="allColors(false)" style="padding:2px 6px;border:1px solid #bbb;border-radius:3px;background:#fff;font-size:0.75em;cursor:pointer;">None</button>
                </div>
                <div class="separator"></div>
                <div class="filter-group">
                    <label>Sort:</label>
                    <select id="sortSelect" onchange="applyFilters()">
                        <option value="avg_z">Avg Z-Score (best first)</option>
                        <option value="cgb_raw">CGB Grade</option>
                        <option value="ds_raw">Draftsim Score</option>
                        <option value="maz_raw">MTG Arena Zone Score</option>
                        <option value="controversy">Spread (max disagreement)</option>
                        <option value="name">Name (A‚ÄìZ)</option>
                    </select>
                </div>
                <button onclick="resetFilters()" style="padding:5px 10px;border:1px solid #bbb;border-radius:4px;background:#fff;font-size:0.82em;cursor:pointer;">Reset</button>
                <div class="separator"></div>
                <label style="display:flex;align-items:center;gap:5px;font-size:0.82em;cursor:pointer;font-weight:600;">
                    <input type="checkbox" id="toggleImages" onchange="toggleInlineImages(this.checked)"> Show card images
                </label>
            </div>

            <div class="table-wrapper">
                <table id="ratingsTable">
                    <thead>
                        <tr>
                            <th class="name-col" onclick="sortBy('name')">Card Name<span class="sort-indicator"></span></th>
                            <th onclick="sortBy('color')" style="width:48px">Color<span class="sort-indicator"></span></th>
                            <th onclick="sortBy('rarity')" style="width:38px">Rar<span class="sort-indicator"></span></th>
                            <th class="col-cgb" onclick="sortBy('cgb_raw')" style="width:52px" title="CardGameBase">CGB<span class="sort-indicator"></span></th>
                            <th class="col-cgb" onclick="sortBy('cgb_z')" style="width:52px" title="CardGameBase z-score">CGB Z<span class="sort-indicator"></span></th>
                            <th class="col-ds" onclick="sortBy('ds_raw')" style="width:52px" title="Draftsim score /10">DS<span class="sort-indicator"></span></th>
                            <th class="col-ds" onclick="sortBy('ds_z')" style="width:52px" title="Draftsim z-score">DS Z<span class="sort-indicator"></span></th>
                            <th class="col-maz" onclick="sortBy('maz_raw')" style="width:52px" title="MTG Arena Zone score /10">MAZ<span class="sort-indicator"></span></th>
                            <th class="col-maz" onclick="sortBy('maz_z')" style="width:52px" title="MTG Arena Zone z-score">MAZ Z<span class="sort-indicator"></span></th>
                            <th class="col-avg norm-bar-cell" onclick="sortBy('avg_z')" title="Average of available z-scores">Avg Z<span class="sort-indicator"></span></th>
                            <th class="col-controversy" onclick="sortBy('controversy')" style="width:80px" title="Max z-score spread">Spread<span class="sort-indicator"></span></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div id="noResults" class="no-results" style="display:none;">No cards match current filters.</div>
            </div>
            <div class="stats-bar" id="statsBar">Loading...</div>
        </div>
    </div>

    <div class="card-tooltip" id="cardTooltip"></div>

    <!-- Color Wheel (React) -->
    <script type="text/babel">

/**
 * TMNT (Teenage Mutant Ninja Turtles) Draft Archetypes - Color Wheel Visualization
 * 1.0.0 React (STABLE)
 *
 * Set: Teenage Mutant Ninja Turtles (TMT)
 * Release: March 6, 2026
 * Format: 5 enemy-color-pair archetypes
 *
 * CHANGELOG:
 * 1.0.4 (2026-02-28, UTC) - [Claude Sonnet 4.6] - Header cleanup; Scryfall button updates
 *   - Merged low-contrast sources warning into subtitle paragraph (readable dark-on-light)
 *   - Added Scryfall full set link to subtitle
 *   - Color boxes: replaced "X identity" (id=X) with "X included" (id>=X)
 *   - Archetype table cards: removed redundant "Full TMT" button (now in subtitle)
 * 1.0.3 (2026-02-28, UTC) - [Claude Sonnet 4.6] - Dim off-arch lines and boxes on wheel
 *   - Secondary (allied-pair) edge lines now render at 45% opacity vs 100% for primary
 *   - Secondary label boxes now render at 50% opacity vs 100% for primary
 *   - Dimmed-hover thresholds adjusted accordingly (0.1 / 0.15)
 * 1.0.2 (2026-02-28, UTC) - [Claude Sonnet 4.6] - Popup on wheel only; Scryfall buttons in archetype tables
 *   - InfoPanel popup now triggered only by SVG color wheel hover, not table cards
 *   - Added Scryfall search buttons inline in all 10 archetype table cards (primary + secondary)
 *   - Removed onMouseEnter/onMouseLeave handlers from table card divs
 * 1.0.1 (2026-02-28, UTC) - [Claude Sonnet 4.6] - Fix sourcing: wire up per-archetype sourceText/sourceUrl
 *   - labels[] now has sourceText + sourceUrl per pair (was dead data before)
 *   - InfoPanel now renders actual source link from labels, not the unused sourceLinks object
 *   - Archetype grid cards now show source attribution
 *   - Header now has explicit sourcing disclosure with links to all 4 sources
 *   - Removed unused sourceLinks object
 *   - Mechanic descriptions now clearly flagged as pre-release expert consensus
 * 1.0.0 (2026-02-27, UTC) - [Claude Sonnet 4.6] - Initial build for TMNT set
 *   - Enemy-color-pair archetypes: WB (Sneak), UR (Machines), BG (Disappear), RW (Alliance), GU (Mutagen)
 *   - Sources: Wizards prerelease guide, Draftsim, CardGameBase, TheGamer
 */

const { useState, useEffect, useRef } = React;

const isMobile = () => window.innerWidth <= 768;

const getConfig = (textSizeMultiplier = 1.0) => {
  const mobile = isMobile();
  const baseFontSize = mobile ? 10 : 11;
  const scaledFontSize = Math.round(baseFontSize * textSizeMultiplier);
  return {
    width: 700,
    height: 700,
    cx: 350,
    cy: 330,
    radius: mobile ? 140 : 180,
    nodeRadius: mobile ? 24 : 30,
    edgeWidth: mobile ? 4 : 5,
    boxW: mobile ? 58 : 62,
    boxH: mobile ? 32 : 36,
    primaryBoxW: mobile ? 68 : 72,
    primaryBoxH: mobile ? 40 : 44,
    fontSize: scaledFontSize,
    lineSpacing: mobile ? 9 : 10,
    iterMax: 240,
    pushStep: 6,
  };
};

let CONFIG = getConfig();

const baseHex = {
  W: "#FFFFFF",
  U: "#3366FF",
  B: "#000000",
  R: "#FF3333",
  G: "#2ECC40",
};

// TMNT uses enemy-color-pair archetypes (the 5 supported pairs)
const primaryArchetypes = ['WB', 'UR', 'BG', 'RW', 'GU'];


const manaClasses = {
  W: 'ms ms-w',
  U: 'ms ms-u',
  B: 'ms ms-b',
  R: 'ms ms-r',
  G: 'ms ms-g',
};

const colorDescriptions = {
  W: {
    name: "White",
    description: "Sneaky ninjas, Alliance go-wide. Features Leonardo's Foot Clan discipline and Sally Pride's coalition-building. Partners with Black (Sneak) and Red (Alliance)."
  },
  U: {
    name: "Blue",
    description: "Artifact machines and Mutagen science. Donatello's technology drives artifact synergies. Partners with Red (Machines) and Green (Mutagen tokens)."
  },
  B: {
    name: "Black",
    description: "Ninja deception and Disappear triggers. When your permanents leave the battlefield, generate value. Partners with White (Sneak) and Green (Disappear)."
  },
  R: {
    name: "Red",
    description: "Aggressive Alliance and artifact combat. Raphael's raw attitude fuels attack triggers. Partners with White (Alliance) and Blue (Machines artifacts)."
  },
  G: {
    name: "Green",
    description: "Mutagen tokens and graveyard Disappear. Mutant creatures grow and multiply. Partners with Blue (Mutagen) and Black (Disappear value)."
  }
};

// TMNT archetypes: 5 enemy pairs are primary, 5 allied pairs are secondary/off-theme
// Archetype names and mechanic descriptions sourced from:
//   - Wizards of the Coast prerelease guide / product page
//   - Draftsim TMNT limited set review (draftsim.com/mtg-tmt-limited-set-review/)
//   - TheGamer TMNT draft archetypes article
//   - GameDaily TMNT prerelease guide
// "Best-performing" claims come from pre-release expert consensus; no 17Lands data yet (set releases 2026-03-06)
const labels = {
  // Primary enemy-pair archetypes
  WB: { text: "Ninjas", sub: "Sneak", details: "Sneak mechanic replaces unblocked creatures with stronger ninja threats from hand or library. Leonardo and Splinter lead disciplined strike forces that attack from the shadows. Overwhelming tempo advantage when sneaks resolve.", sourceText: "WotC / Draftsim / TheGamer", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  UR: { text: "Machines", sub: "Artifacts", details: "Donatello's lab powers artifact-heavy Blue/Red decks. Technodrome, robots, and gadgets generate value and board presence. Pre-release consensus: one of the stronger archetypes ‚Äî combine artifact synergies with aggressive Red threats.", sourceText: "WotC / Draftsim / TheGamer", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  BG: { text: "Ooze", sub: "Disappear", details: "Disappear triggers when your permanents leave the battlefield, generating value through sacrifice and removal. Michelangelo's chaos and the ooze subtype create recursive value loops. Great at grinding out opponents.", sourceText: "WotC / Draftsim / GameDaily", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  RW: { text: "Alliance", sub: "Go-wide tokens", details: "Alliance is a returning mechanic that triggers whenever another creature enters under your control. Stack creature-count payoffs, go wide with tokens, and overwhelm opponents. Recommended by reviewers for newer players ‚Äî straightforward and powerful.", sourceText: "WotC / Draftsim / TheGamer", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  GU: { text: "Mutagen", sub: "Mutant tokens", details: "Mutagen tokens represent the ooze that transforms ordinary creatures into mutants. Pre-release consensus: one of the stronger archetypes ‚Äî grow enormous mutant threats while accumulating incremental value. The Mutagen Man epitomizes this strategy.", sourceText: "WotC / Draftsim / TheGamer", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  // Secondary allied-pair notes (off-archetype splashes)
  WU: { text: "Off-arch", sub: "Splash W/U", details: "No dedicated WU archetype in TMT. This color pair bridges Ninjas (WB) and Machines (UR). Consider splashing for powerful individual cards ‚Äî Krang Master Mind (U), Sally Pride (W) are exceptional off-color inclusions.", sourceText: "Draftsim pre-release review", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  UB: { text: "Off-arch", sub: "Splash U/B", details: "No dedicated UB archetype. Bridges Machines (UR) and Ooze/Disappear (BG). April O'Neil works in either direction. Splashing strong black removal or blue card draw is viable if your manabase supports it.", sourceText: "Draftsim pre-release review", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  BR: { text: "Off-arch", sub: "Splash B/R", details: "No dedicated BR archetype. Bridges Ooze (BG) and Alliance (RW). Raphael cards span both colors. Aggressive black/red builds can work with creature-based removal and direct pressure.", sourceText: "Draftsim pre-release review", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  RG: { text: "Off-arch", sub: "Splash R/G", details: "No dedicated RG archetype. Bridges Alliance (RW) and Mutagen (GU). Green ramp into red threats is viable. Groundchuck & Dirtbag provide Mutagen-adjacent value in non-dedicated builds.", sourceText: "Draftsim pre-release review", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
  GW: { text: "Off-arch", sub: "Splash G/W", details: "No dedicated GW archetype. Bridges Mutagen (GU) and Ninja/Alliance (WB, RW). Sally Pride's Alliance payoffs pair naturally with green's wide board. Token-heavy GW shells can work around Alliance triggers.", sourceText: "Draftsim pre-release review", sourceUrl: "https://draftsim.com/mtg-tmt-limited-set-review/" },
};

const hexToRgb = (h) => {
  const hex = h.replace('#', '');
  return [
    parseInt(hex.substring(0, 2), 16),
    parseInt(hex.substring(2, 4), 16),
    parseInt(hex.substring(4, 6), 16),
  ];
};

const rgbToHex = (r, g, b) =>
  '#' + [r, g, b].map(x => Math.round(x).toString(16).padStart(2, '0')).join('');

const darken = (h, amt = 0.4) => {
  const [r, g, b] = hexToRgb(h);
  return rgbToHex(r * (1 - amt), g * (1 - amt), b * (1 - amt));
};

const blend = (u, v) => {
  const [r1, g1, b1] = hexToRgb(baseHex[u]);
  const [r2, g2, b2] = hexToRgb(baseHex[v]);
  return rgbToHex((r1 + r2) / 2, (g1 + g2) / 2, (b1 + b2) / 2);
};

const relLum = (h) => {
  const [r, g, b] = hexToRgb(h).map(x => x / 255);
  const f = (c) => (c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4));
  return 0.2126 * f(r) + 0.7152 * f(g) + 0.0722 * f(b);
};

const contrastRatio = (bg, fg) => {
  const [L1, L2] = [relLum(bg), relLum(fg)].sort((a, b) => b - a);
  return (L1 + 0.05) / (L2 + 0.05);
};

const getLabelColors = (u, v) => {
  let bg, fg;
  if (u === 'B' || v === 'B') {
    bg = '#000000';
    const partner = u === 'B' ? v : u;
    fg = partner === 'W' ? '#FFFFFF' : baseHex[partner];
  } else if (u === 'W' || v === 'W') {
    const partner = u === 'W' ? v : u;
    bg = darken(baseHex[partner], 0.4);
    fg = '#FFFFFF';
  } else {
    bg = darken(baseHex[u], 0.4);
    fg = baseHex[v];
    if (contrastRatio(bg, fg) < 4.5) {
      const [r, g, b] = hexToRgb(fg);
      fg = rgbToHex(Math.min(r + 140, 255), Math.min(g + 140, 255), Math.min(b + 140, 255));
    }
  }
  return { bg, fg };
};

const colorOrder = ['W', 'U', 'B', 'R', 'G'];

const edges = Object.keys(labels).map(pair => ({
  u: pair[0],
  v: pair[1],
  uIdx: colorOrder.indexOf(pair[0]),
  vIdx: colorOrder.indexOf(pair[1]),
}));

const getNodePos = (index, config) => {
  const angle = (index * 72 - 90) * (Math.PI / 180);
  return {
    x: config.cx + config.radius * Math.cos(angle),
    y: config.cy + config.radius * Math.sin(angle),
  };
};

const getNodePositions = (config) => colorOrder.map((_, i) => getNodePos(i, config));

const getEdgeGeometry = (uIdx, vIdx, config) => {
  const nodePositions = getNodePositions(config);
  const p1 = nodePositions[uIdx];
  const p2 = nodePositions[vIdx];
  const dx = p2.x - p1.x;
  const dy = p2.y - p1.y;
  const L = Math.hypot(dx, dy);
  const ux = dx / L;
  const uy = dy / L;

  const x = (p1.x + ux * config.nodeRadius + p2.x - ux * config.nodeRadius) / 2;
  const y = (p1.y + uy * config.nodeRadius + p2.y - uy * config.nodeRadius) / 2;

  const tx = ux, ty = uy;
  const nx = -uy, ny = ux;

  return { x, y, tx, ty, nx, ny };
};

const getBbox = (cx, cy, isPrimary, config) => {
  const w = isPrimary ? config.primaryBoxW : config.boxW;
  const h = isPrimary ? config.primaryBoxH : config.boxH;
  return {
    x1: cx - w / 2,
    x2: cx + w / 2,
    y1: cy - h / 2,
    y2: cy + h / 2,
  };
};

const isOverlap = (b1, b2, margin = 2) => {
  return !(b1.x2 + margin < b2.x1 || b2.x2 + margin < b1.x1 ||
           b1.y2 + margin < b2.y1 || b2.y2 + margin < b1.y1);
};

const computeLabelPositions = (config) => {
  const groups = edges.map(edge => {
    const pairCode = edge.u + edge.v;
    const isPrimary = primaryArchetypes.includes(pairCode);
    const { x, y, tx, ty, nx, ny } = getEdgeGeometry(edge.uIdx, edge.vIdx, config);

    const sgn = (x - config.cx) * nx + (y - config.cy) * ny > 0 ? 1 : -1;
    const off = sgn * (isPrimary ? 20 : 15);
    const tshift = edge.u < edge.v ? 3 : -3;

    const cx = x + nx * off + tx * tshift;
    const cy = y + ny * off + ty * tshift;

    return {
      ...edge,
      cx,
      cy,
      isPrimary,
      bbox: getBbox(cx, cy, isPrimary, config),
    };
  });

  for (let iter = 0; iter < config.iterMax; iter++) {
    let moved = false;
    for (let i = 0; i < groups.length; i++) {
      for (let j = i + 1; j < groups.length; j++) {
        if (isOverlap(groups[i].bbox, groups[j].bbox)) {
          const dx = groups[i].cx - groups[j].cx;
          const dy = groups[i].cy - groups[j].cy;
          const L = Math.hypot(dx, dy) + 0.001;

          groups[i].cx += (dx / L) * config.pushStep;
          groups[i].cy += (dy / L) * config.pushStep;
          groups[j].cx -= (dx / L) * config.pushStep;
          groups[j].cy -= (dy / L) * config.pushStep;

          groups[i].bbox = getBbox(groups[i].cx, groups[i].cy, groups[i].isPrimary, config);
          groups[j].bbox = getBbox(groups[j].cx, groups[j].cy, groups[j].isPrimary, config);
          moved = true;
        }
      }
    }
    if (!moved) break;
  }

  return groups;
};

const ManaSymbol = ({ color, size = 24, isSimple = false }) => {
  const fontColor = isSimple ? '#000000' : (color === 'W' ? '#000000' : '#FFFFFF');
  return (
    <i
      className={manaClasses[color]}
      style={{
        fontSize: `${size}px`,
        color: fontColor,
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
      }}
    />
  );
};

const ColorNode = ({ color, index, isHighlighted, isDimmed, onHover, onLeave, isSimple = false, config }) => {
  const nodePositions = getNodePositions(config);
  const pos = nodePositions[index];
  const fontColor = isSimple ? '#000000' : (color === 'W' ? '#000000' : '#FFFFFF');
  const nodeColor = isSimple ? '#FFFFFF' : baseHex[color];
  const glowColor = isSimple ? 'transparent' : baseHex[color];

  return (
    <g
      onMouseEnter={onHover}
      onMouseLeave={onLeave}
      style={{ cursor: 'pointer', transition: 'opacity 0.2s ease' }}
      opacity={isDimmed ? 0.3 : 1}
    >
      <circle
        cx={pos.x}
        cy={pos.y}
        r={config.nodeRadius + (isHighlighted ? 12 : 8)}
        fill={isHighlighted ? "#FFD700" : glowColor}
        opacity={isHighlighted ? 0.6 : 0.25}
        style={{ transition: 'all 0.2s ease' }}
      />
      <circle
        cx={pos.x}
        cy={pos.y}
        r={config.nodeRadius}
        fill={nodeColor}
        stroke={isHighlighted ? "#FFD700" : "#000000"}
        strokeWidth={isHighlighted ? 4 : 3}
        style={{ transition: 'all 0.2s ease' }}
      />
      <foreignObject
        x={pos.x - 20}
        y={pos.y - 20}
        width={40}
        height={40}
      >
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          width: '40px',
          height: '40px',
          color: fontColor,
        }}>
          <ManaSymbol color={color} size={30} isSimple={isSimple} />
        </div>
      </foreignObject>
    </g>
  );
};

const EdgeLine = ({ edge, isHighlighted, isDimmed, isSimple = false, config }) => {
  const nodePositions = getNodePositions(config);
  const p1 = nodePositions[edge.uIdx];
  const p2 = nodePositions[edge.vIdx];
  const pairCode = edge.u + edge.v;
  const isPrimary = primaryArchetypes.includes(pairCode);
  const lineColor = isSimple ? '#000000' : blend(edge.u, edge.v);
  const lineOpacity = isDimmed ? 0.1 : (isPrimary ? 1 : 0.45);

  return (
    <line
      x1={p1.x}
      y1={p1.y}
      x2={p2.x}
      y2={p2.y}
      stroke={isHighlighted ? "#FFD700" : lineColor}
      strokeWidth={isHighlighted ? config.edgeWidth + 3 : (isPrimary ? config.edgeWidth + 2 : config.edgeWidth)}
      opacity={lineOpacity}
      style={{ transition: 'all 0.2s ease' }}
    />
  );
};

const LabelBox = ({ group, isHighlighted, isDimmed, onHover, onLeave, isSimple = false, config }) => {
  const groupRef = useRef(null);
  const [boxSize, setBoxSize] = useState({ width: 50, height: 35 });

  const code = group.u + group.v;
  const labelData = labels[code] || labels[group.v + group.u];
  const { bg, fg } = getLabelColors(group.u, group.v);
  const edgeColor = blend(group.u, group.v);
  const isPrimary = group.isPrimary;
  const subLines = labelData.sub.split('\n');
  const boxBg = isSimple ? '#FFFFFF' : bg;
  const boxStroke = isSimple ? '#000000' : edgeColor;
  const textColor = isSimple ? '#000000' : fg;

  const fontSize1 = config.fontSize;
  const fontSize2 = config.fontSize;
  const fontSize3 = config.fontSize;
  const lh1 = fontSize1 * 1.1;
  const lh2 = fontSize2 * 1.1;
  const lh3 = fontSize3 * 1.1;
  const subLineSpacing = 7;
  const numSubLines = subLines.length;
  const totalTextHeight = lh1 + lh2 + lh3 + (numSubLines - 1) * subLineSpacing;
  const startY = group.cy - totalTextHeight / 2;
  const y1 = startY + lh1 * 0.8;
  const y2 = y1 + lh2;
  const y3 = y2 + lh3 * 0.9;

  useEffect(() => {
    if (groupRef.current) {
      const texts = groupRef.current.querySelectorAll('text');
      let maxWidth = 0;
      texts.forEach((text) => {
        try {
          const bbox = text.getBBox();
          maxWidth = Math.max(maxWidth, bbox.width);
        } catch (e) {}
      });
      const padding = 4;
      const heightPadding = 3;
      setBoxSize({
        width: Math.max(maxWidth + padding * 2, 35),
        height: totalTextHeight + heightPadding * 2
      });
    }
  }, [code, labelData.text, labelData.sub, config.fontSize, totalTextHeight]);

  return (
    <g
      ref={groupRef}
      onMouseEnter={onHover}
      onMouseLeave={onLeave}
      style={{ cursor: 'pointer', transition: 'all 0.2s ease' }}
      opacity={isDimmed ? 0.15 : (isPrimary ? 1 : 0.5)}
      transform={isHighlighted ? `translate(${group.cx}, ${group.cy}) scale(1.08) translate(${-group.cx}, ${-group.cy})` : undefined}
    >
      <rect
        x={group.cx - boxSize.width / 2}
        y={group.cy - boxSize.height / 2}
        width={boxSize.width}
        height={boxSize.height}
        rx={4}
        fill={boxBg}
        stroke={isHighlighted ? "#FFD700" : boxStroke}
        strokeWidth={isHighlighted ? 3 : (isPrimary ? 2 : 1.5)}
        style={{ transition: 'all 0.2s ease' }}
      />
      <text x={group.cx} y={y1} textAnchor="middle" fontSize={fontSize1} fontWeight="bold" fill={textColor}>
        {code}
      </text>
      <text x={group.cx} y={y2} textAnchor="middle" fontSize={fontSize2} fontWeight={isPrimary ? "bold" : "normal"} fill={textColor}>
        {labelData.text}
      </text>
      <text x={group.cx} y={y3} textAnchor="middle" fontSize={fontSize3} fill={textColor} opacity={0.85}>
        {subLines.map((line, i) => (
          <tspan key={i} x={group.cx} dy={i === 0 ? 0 : subLineSpacing}>{line}</tspan>
        ))}
      </text>
    </g>
  );
};

const ColorGrid = ({ hoveredColor, onColorHover, onColorLeave }) => {
  return (
    <div id="colors" className="color-grid" style={{
      display: 'grid',
      gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
      gap: '12px',
      marginTop: '24px',
      width: '100%',
    }}>
      {colorOrder.map((color) => {
        const colorData = colorDescriptions[color];
        const colorMap = { W: 'white', U: 'blue', B: 'black', R: 'red', G: 'green' };
        const exactSearchUrl = `https://scryfall.com/search?q=set%3Atmt+color%3D${colorMap[color]}`;
        const includedSearchUrl = `https://scryfall.com/search?q=set%3Atmt+id>%3D${color}`;
        const bg = baseHex[color];
        const fg = color === 'W' ? '#000000' : '#FFFFFF';
        const isHovered = hoveredColor === color;

        return (
          <div
            key={color}
            onMouseEnter={() => onColorHover(color)}
            onMouseLeave={onColorLeave}
            style={{
              backgroundColor: bg,
              color: fg,
              padding: '12px',
              borderRadius: '6px',
              textAlign: 'center',
              border: isHovered ? `3px solid #FFD700` : `2px solid ${darken(bg, 0.2)}`,
              boxShadow: isHovered ? '0 0 8px rgba(255, 215, 0, 0.4)' : '0 2px 4px rgba(0,0,0,0.1)',
              transition: 'all 0.2s ease',
              cursor: 'pointer',
            }}
          >
            <div style={{ fontSize: '40px', marginBottom: '6px', color: fg }}>
              <i className={manaClasses[color]} />
            </div>
            <div style={{ fontWeight: 'bold', fontSize: '0.9rem', marginBottom: '4px' }}>
              {color}: {colorData.name}
            </div>
            <div style={{ fontSize: '0.75rem', lineHeight: '1.3', marginBottom: '8px', opacity: 0.9 }}>
              {colorData.description}
            </div>
            <div style={{ fontSize: '0.65rem', opacity: 0.85, marginBottom: '6px', fontWeight: '600' }}>
              Scryfall search:
            </div>
            <div style={{ display: 'flex', gap: '4px', flexDirection: 'column' }}>
              <a
                href={exactSearchUrl}
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'inline-block',
                  padding: '4px 8px',
                  backgroundColor: fg,
                  color: bg,
                  textDecoration: 'none',
                  borderRadius: '3px',
                  fontSize: '0.65rem',
                  fontWeight: '600',
                  transition: 'opacity 0.2s ease',
                  opacity: 0.95,
                }}
              >
                {color} only
              </a>
              <a
                href={includedSearchUrl}
                target="_blank"
                rel="noopener noreferrer"
                style={{
                  display: 'inline-block',
                  padding: '4px 8px',
                  backgroundColor: fg,
                  color: bg,
                  textDecoration: 'none',
                  borderRadius: '3px',
                  fontSize: '0.65rem',
                  fontWeight: '600',
                  transition: 'opacity 0.2s ease',
                  opacity: 0.95,
                }}
              >
                {color} included
              </a>
            </div>
          </div>
        );
      })}
    </div>
  );
};

const InfoPanel = ({ pair, onHover, onLeave }) => {
  if (!pair) return null;

  const labelData = labels[pair];
  const { bg, fg } = getLabelColors(pair[0], pair[1]);
  const isPrimary = primaryArchetypes.includes(pair);

  const exactSearchUrl = `https://scryfall.com/search?q=set%3Atmt+id%3D${pair}`;
  const orSearchUrl = `https://scryfall.com/search?q=set%3Atmt+(id%3D${pair[0]}+or+id%3D${pair[1]}+or+id%3D${pair})`;
  const scrySetUrl = `https://scryfall.com/sets/tmt`;

  return (
    <div
      onMouseEnter={onHover}
      onMouseLeave={onLeave}
      style={{
        position: 'fixed',
        bottom: '20px',
        left: '50%',
        transform: 'translateX(-50%)',
        backgroundColor: bg,
        color: fg,
        padding: '16px 24px',
        borderRadius: '8px',
        border: `2px solid ${blend(pair[0], pair[1])}`,
        maxWidth: '500px',
        textAlign: 'center',
        boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
        transition: 'all 0.2s ease',
        zIndex: 1000,
      }}>
      <div style={{ fontWeight: 'bold', fontSize: '1.2rem', marginBottom: '4px' }}>
        {pair}: {labelData.text} {isPrimary ? '‚òÖ' : ''}
      </div>
      <div style={{ fontSize: '0.9rem', opacity: 0.9, marginBottom: '8px' }}>
        {labelData.sub}
      </div>
      <div style={{ fontSize: '0.85rem', lineHeight: '1.4', marginBottom: '8px' }}>
        {labelData.details}
      </div>
      {labelData.sourceText && (
        <div style={{ fontSize: '0.75rem', opacity: 0.8, marginBottom: '12px', fontStyle: 'italic' }}>
          Source: <a href={labelData.sourceUrl} target="_blank" rel="noopener noreferrer" style={{ color: fg, textDecoration: 'underline' }}>{labelData.sourceText}</a>
          {' ¬∑ Pre-release expert consensus; no 17Lands data yet'}
        </div>
      )}
      <div style={{ fontSize: '0.7rem', opacity: 0.9, marginBottom: '8px', fontWeight: '600' }}>
        Scryfall search:
      </div>
      <div style={{ display: 'flex', gap: '6px', justifyContent: 'center', flexWrap: 'wrap' }}>
        <a href={exactSearchUrl} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-block', padding: '6px 14px', backgroundColor: fg, color: bg, textDecoration: 'none', borderRadius: '4px', fontSize: '0.75rem', fontWeight: '600' }}>
          {pair[0]}&amp;{pair[1]}
        </a>
        <a href={orSearchUrl} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-block', padding: '6px 14px', backgroundColor: fg, color: bg, textDecoration: 'none', borderRadius: '4px', fontSize: '0.75rem', fontWeight: '600' }}>
          {pair[0]}‚à™{pair[1]}
        </a>
        <a href={scrySetUrl} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-block', padding: '6px 14px', backgroundColor: fg, color: bg, textDecoration: 'none', borderRadius: '4px', fontSize: '0.75rem', fontWeight: '600' }}>
          Full TMT Set
        </a>
      </div>
    </div>
  );
};

function TMNTColorWheel() {
  const [hoveredNode, setHoveredNode] = useState(null);
  const [hoveredPair, setHoveredPair] = useState(null);
  const [hoveredColor, setHoveredColor] = useState(null);
  const [isSimple, setIsSimple] = useState(false);
  const [textSize, setTextSize] = useState(1.0);
  const [config, setConfig] = useState(() => getConfig(1.0));
  const pairTimeoutRef = useRef(null);
  const colorTimeoutRef = useRef(null);

  useEffect(() => {
    const handleResize = () => { setConfig(getConfig(textSize)); };
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, [textSize]);

  useEffect(() => { setConfig(getConfig(textSize)); }, [textSize]);

  const labelPositions = computeLabelPositions(config);

  const handlePairHover = (pairCode) => {
    if (pairTimeoutRef.current) { clearTimeout(pairTimeoutRef.current); pairTimeoutRef.current = null; }
    setHoveredPair(pairCode);
  };

  const handlePairLeave = () => {
    pairTimeoutRef.current = setTimeout(() => { setHoveredPair(null); }, 800);
  };

  const handleColorHover = (color) => {
    if (colorTimeoutRef.current) { clearTimeout(colorTimeoutRef.current); colorTimeoutRef.current = null; }
    setHoveredColor(color);
  };

  const handleColorLeave = () => {
    colorTimeoutRef.current = setTimeout(() => { setHoveredColor(null); }, 800);
  };

  useEffect(() => {
    const handleHashChange = () => {
      const hash = window.location.hash.slice(1);
      if (hash) {
        const element = document.getElementById(hash);
        if (element) element.scrollIntoView({ behavior: 'smooth' });
      }
    };
    window.addEventListener('hashchange', handleHashChange);
    handleHashChange();
    return () => window.removeEventListener('hashchange', handleHashChange);
  }, []);

  useEffect(() => {
    return () => {
      if (pairTimeoutRef.current) clearTimeout(pairTimeoutRef.current);
      if (colorTimeoutRef.current) clearTimeout(colorTimeoutRef.current);
    };
  }, []);

  const activeColors = hoveredPair ? [hoveredPair[0], hoveredPair[1]] : (hoveredNode ? [hoveredNode] : []);
  const activePair = hoveredPair;

  const primaryPairs = Object.entries(labels).filter(([pair]) => primaryArchetypes.includes(pair));
  const secondaryPairs = Object.entries(labels).filter(([pair]) => !primaryArchetypes.includes(pair));

  return (
    <div className="main-container" style={{
      minHeight: '100vh',
      backgroundColor: '#FFFFFF',
      padding: '24px',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      position: 'relative',
    }}>
      {/* Header */}
      <div style={{ textAlign: 'center', marginBottom: '24px' }}>
        <h1 style={{ fontSize: '1.8rem', fontWeight: '700', color: '#111827', margin: '0 0 4px 0' }}>
          üê¢ Teenage Mutant Ninja Turtles
        </h1>
        <p style={{ fontSize: '0.95rem', color: '#6B7280', margin: '0 0 4px 0' }}>
          Draft Archetypes Color Wheel (1.0.0 Interactive)
        </p>
        <p style={{ fontSize: '0.75rem', color: '#9CA3AF', margin: '0 0 4px 0' }}>
          Set code: TMT ¬∑ Releases: March 6, 2026 ¬∑ Last updated: 2026-02-27 UTC
        </p>
        <div style={{ display: 'inline-block', margin: '4px 0 8px', padding: '4px 12px', borderRadius: '999px', background: '#10B981', color: 'white', fontSize: '0.75rem', fontWeight: '600' }}>
          ‚òÖ 5 enemy-color-pair archetypes
        </div>
        <p style={{ fontSize: '0.85rem', color: '#9CA3AF', margin: '4px 0 8px 0' }}>
          <a href="#colors" style={{ color: '#2563EB', textDecoration: 'underline' }}>Colors</a> | <a href="#primary-archetypes" style={{ color: '#2563EB', textDecoration: 'underline' }}>Primary Archetypes</a> | <a href="#secondary-archetypes" style={{ color: '#2563EB', textDecoration: 'underline' }}>Off-Arch Splashes</a>
        </p>
        <p style={{ fontSize: '0.8rem', color: '#6B7280', margin: '0 0 0 0', lineHeight: '1.6' }}>
          New to this set? See the <a href="https://magic.wizards.com/en/products/teenage-mutant-ninja-turtles" target="_blank" rel="noopener noreferrer" style={{ color: '#2563EB', textDecoration: 'underline' }}>TMNT Product Page</a> or browse the <a href="https://scryfall.com/sets/tmt" target="_blank" rel="noopener noreferrer" style={{ color: '#2563EB', textDecoration: 'underline' }}>full set on Scryfall</a>.<br />
          Want full ratings? See <a href="https://draftsim.com/mtg-tmt-limited-set-review/" target="_blank" rel="noopener noreferrer" style={{ color: '#2563EB', textDecoration: 'underline' }}>Draftsim set review</a>, <a href="https://www.thegamer.com/magic-the-gathering-teenage-mutant-ninja-turtles-best-draft-archetypes/" target="_blank" rel="noopener noreferrer" style={{ color: '#2563EB', textDecoration: 'underline' }}>TheGamer archetypes guide</a>, <a href="https://gamedaily.com/games/mtg-teenage-mutant-ninja-turtles-prerelease-guide-all-limited-archetypes-explained/" target="_blank" rel="noopener noreferrer" style={{ color: '#2563EB', textDecoration: 'underline' }}>GameDaily prerelease guide</a>, or <a href="ratings.html" style={{ color: '#2563EB', textDecoration: 'underline' }}>our Ratings Viewer</a>.
        </p>
      </div>

      {/* Controls */}
      <div style={{ display: 'flex', gap: '24px', alignItems: 'center', justifyContent: 'center', marginBottom: '12px', flexWrap: 'wrap' }}>
        <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', fontSize: '0.9rem', fontWeight: '500', color: '#374151' }}>
          <input type="checkbox" checked={isSimple} onChange={(e) => setIsSimple(e.target.checked)} style={{ width: '16px', height: '16px', cursor: 'pointer' }} />
          B&amp;W
        </label>
        <label style={{ display: 'flex', alignItems: 'center', gap: '8px', fontSize: '0.9rem', fontWeight: '500', color: '#374151' }}>
          Text Size:
          <input type="range" min="0.5" max="2.0" step="0.1" value={textSize} onChange={(e) => setTextSize(parseFloat(e.target.value))} style={{ width: '80px', cursor: 'pointer' }} />
          <span style={{ minWidth: '35px', fontSize: '0.8rem', color: '#6B7280' }}>{Math.round(textSize * 100)}%</span>
        </label>
      </div>

      {/* SVG Color Wheel */}
      <svg
        className="color-wheel-svg"
        viewBox={isMobile() ? "160 140 380 400" : "120 100 460 480"}
        style={{ width: '100%', maxWidth: '700px', height: 'auto', display: 'block', margin: '0 auto' }}
      >
        {edges.map((edge, i) => {
          const pairCode = edge.u + edge.v;
          const isHighlighted = activePair === pairCode;
          const isDimmed = activeColors.length > 0 && !activeColors.includes(edge.u) && !activeColors.includes(edge.v);
          return (
            <EdgeLine key={`edge-${i}`} edge={edge} isHighlighted={isHighlighted} isDimmed={isDimmed} isSimple={isSimple} config={config} />
          );
        })}

        {labelPositions.map((group, i) => {
          const pairCode = group.u + group.v;
          const isHighlighted = activePair === pairCode;
          const isDimmed = activeColors.length > 0 && !activeColors.includes(group.u) && !activeColors.includes(group.v);
          return (
            <LabelBox
              key={`label-${i}`}
              group={group}
              isHighlighted={isHighlighted}
              isDimmed={isDimmed}
              onHover={() => handlePairHover(pairCode)}
              onLeave={handlePairLeave}
              isSimple={isSimple}
              config={config}
            />
          );
        })}

        {colorOrder.map((color, index) => {
          const isHighlighted = hoveredNode === color || activeColors.includes(color);
          const isDimmed = activeColors.length > 0 && !activeColors.includes(color);
          return (
            <ColorNode
              key={`node-${color}`}
              color={color}
              index={index}
              isHighlighted={isHighlighted}
              isDimmed={isDimmed}
              onHover={() => setHoveredNode(color)}
              onLeave={() => setHoveredNode(null)}
              isSimple={isSimple}
              config={config}
            />
          );
        })}
      </svg>

      {/* Color Grid */}
      <ColorGrid hoveredColor={hoveredColor} onColorHover={handleColorHover} onColorLeave={handleColorLeave} />

      {/* Primary Archetypes */}
      <div id="primary-archetypes" style={{ width: '100%', marginTop: '32px' }}>
        <h2 style={{ fontSize: '1.3rem', fontWeight: '700', color: '#111827', marginBottom: '16px', paddingBottom: '8px', borderBottom: '2px solid #10B981' }}>
          ‚òÖ Primary Archetypes (Enemy Color Pairs)
        </h2>
        <div className="archetype-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(100%, 150px), 1fr))', gap: '12px', alignSelf: 'stretch' }}>
          {primaryPairs.map(([pair, data]) => {
            const { bg, fg } = getLabelColors(pair[0], pair[1]);
            const exactSearchUrl = `https://scryfall.com/search?q=set%3Atmt+id%3D${pair}`;
            const orSearchUrl = `https://scryfall.com/search?q=set%3Atmt+(id%3D${pair[0]}+or+id%3D${pair[1]}+or+id%3D${pair})`;
            return (
              <div key={pair} style={{ backgroundColor: bg, color: fg, padding: '16px', borderRadius: '8px', border: `2px solid ${blend(pair[0], pair[1])}` }}>
                <div style={{ fontWeight: 'bold', fontSize: '1.1rem', marginBottom: '4px' }}>{pair}: {data.text}</div>
                <div style={{ fontSize: '0.85rem', opacity: 0.9, marginBottom: '8px', fontStyle: 'italic' }}>{data.sub}</div>
                <div style={{ fontSize: '0.8rem', lineHeight: '1.4', opacity: 0.95, marginBottom: '8px' }}>{data.details}</div>
                {data.sourceText && (
                  <div style={{ fontSize: '0.7rem', opacity: 0.7, fontStyle: 'italic', marginBottom: '10px' }}>
                    Source: <a href={data.sourceUrl} target="_blank" rel="noopener noreferrer" style={{ color: fg, textDecoration: 'underline' }}>{data.sourceText}</a>
                  </div>
                )}
                <div style={{ fontSize: '0.65rem', opacity: 0.85, marginBottom: '5px', fontWeight: '600' }}>Scryfall search:</div>
                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                  <a href={exactSearchUrl} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-block', padding: '4px 10px', backgroundColor: fg, color: bg, textDecoration: 'none', borderRadius: '3px', fontSize: '0.65rem', fontWeight: '600' }}>
                    {pair[0]}&amp;{pair[1]}
                  </a>
                  <a href={orSearchUrl} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-block', padding: '4px 10px', backgroundColor: fg, color: bg, textDecoration: 'none', borderRadius: '3px', fontSize: '0.65rem', fontWeight: '600' }}>
                    {pair[0]}‚à™{pair[1]}
                  </a>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Secondary Archetypes */}
      <div id="secondary-archetypes" style={{ width: '100%', marginTop: '32px', marginBottom: '48px' }}>
        <h2 style={{ fontSize: '1.3rem', fontWeight: '700', color: '#111827', marginBottom: '8px', paddingBottom: '8px', borderBottom: '2px solid #9CA3AF' }}>
          Off-Arch Splashes (Allied Color Pairs)
        </h2>
        <p style={{ fontSize: '0.85rem', color: '#6B7280', marginBottom: '16px' }}>
          These 5 allied color pairs have no dedicated archetype in TMT. See splash guidance below.
        </p>
        <div className="archetype-grid" style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(min(100%, 150px), 1fr))', gap: '12px', alignSelf: 'stretch' }}>
          {secondaryPairs.map(([pair, data]) => {
            const { bg, fg } = getLabelColors(pair[0], pair[1]);
            const exactSearchUrl = `https://scryfall.com/search?q=set%3Atmt+id%3D${pair}`;
            const orSearchUrl = `https://scryfall.com/search?q=set%3Atmt+(id%3D${pair[0]}+or+id%3D${pair[1]}+or+id%3D${pair})`;
            return (
              <div key={pair} style={{ backgroundColor: bg, color: fg, padding: '16px', borderRadius: '8px', border: `1px dashed ${blend(pair[0], pair[1])}`, opacity: 0.85 }}>
                <div style={{ fontWeight: 'bold', fontSize: '1.1rem', marginBottom: '4px' }}>{pair}: {data.text}</div>
                <div style={{ fontSize: '0.85rem', opacity: 0.9, marginBottom: '8px', fontStyle: 'italic' }}>{data.sub}</div>
                <div style={{ fontSize: '0.8rem', lineHeight: '1.4', opacity: 0.95, marginBottom: '8px' }}>{data.details}</div>
                {data.sourceText && (
                  <div style={{ fontSize: '0.7rem', opacity: 0.7, fontStyle: 'italic', marginBottom: '10px' }}>
                    Source: <a href={data.sourceUrl} target="_blank" rel="noopener noreferrer" style={{ color: fg, textDecoration: 'underline' }}>{data.sourceText}</a>
                  </div>
                )}
                <div style={{ fontSize: '0.65rem', opacity: 0.85, marginBottom: '5px', fontWeight: '600' }}>Scryfall search:</div>
                <div style={{ display: 'flex', gap: '4px', flexWrap: 'wrap' }}>
                  <a href={exactSearchUrl} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-block', padding: '4px 10px', backgroundColor: fg, color: bg, textDecoration: 'none', borderRadius: '3px', fontSize: '0.65rem', fontWeight: '600' }}>
                    {pair[0]}&amp;{pair[1]}
                  </a>
                  <a href={orSearchUrl} target="_blank" rel="noopener noreferrer" style={{ display: 'inline-block', padding: '4px 10px', backgroundColor: fg, color: bg, textDecoration: 'none', borderRadius: '3px', fontSize: '0.65rem', fontWeight: '600' }}>
                    {pair[0]}‚à™{pair[1]}
                  </a>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Hover Info Panel ‚Äî triggered by SVG wheel only */}
      <InfoPanel pair={activePair} onHover={() => { if (pairTimeoutRef.current) { clearTimeout(pairTimeoutRef.current); pairTimeoutRef.current = null; } }} onLeave={handlePairLeave} />
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('color-wheel-root'));
root.render(<TMNTColorWheel />);
  
    </script>

    <!-- Ratings Table (Vanilla JS) -->
    <script>

// ‚îÄ‚îÄ Raw data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// CardGameBase grades. Format: [name, color, rarity, grade]
// Colors: W U B R G M=Multi C=Artifact/Colorless L=Land
// Rarity: C U R M L
const CGB_DATA = [
    ["Sally Pride, Lioness Leader","W","R","A+"],
    ["Triceraton Commander","R","R","A+"],
    ["Krang, Master Mind","U","M","A+"],
    ["Armaggon, Future Shark","B","R","A+"],
    ["Mutagen Man, Living Ooze","G","R","A+"],
    ["The Last Ronin","M","M","A+"],
    ["Krang & Shredder","M","M","A+"],
    ["North Wind Avatar","U","R","A+"],
    ["Raph & Mikey, Troublemakers","M","R","A+"],
    ["Umezawa's Jitte","C","M","A+"],
    ["Leader's Talent","W","U","A-"],
    ["Turncoat Kunoichi","B","U","A-"],
    ["The Cloning of Shredder","B","R","A-"],
    ["Agent Bishop, Man in Black","W","R","B+"],
    ["Mighty Mutanimals","G","U","B+"],
    ["April O'Neil, Hacktivist","U","R","B+"],
    ["Does Machines","U","U","B+"],
    ["Renet, Temporal Apprentice","W","R","B+"],
    ["Rat King, Verminister","B","R","B+"],
    ["Savanti Romero, Time's Exile","R","R","B+"],
    ["Groundchuck & Dirtbag","G","R","B+"],
    ["Brilliance Unleashed","U","U","B+"],
    ["Karai's Technique","B","U","B+"],
    ["Shadowspear","C","M","B+"],
    ["Dimensional Exile","W","U","B"],
    ["Leonardo, Sewer Samurai","W","R","B"],
    ["Metalhead","C","U","B"],
    ["Shark Shredder, Killer Clone","U","R","B"],
    ["Super Shredder","B","M","B"],
    ["General Traag, Heart of Stone","R","R","B"],
    ["Ravenous Robots","C","U","B"],
    ["Slash, Reptile Rampager","G","U","B"],
    ["Spicy Oatmeal Pizza","C","U","B"],
    ["Courier of Comestibles","W","C","B"],
    ["Leatherhead, Swamp Stalker","G","R","B"],
    ["Michelangelo, Improviser","R","U","B"],
    ["Michelangelo, Weirdness to 11","G","R","B"],
    ["The Ooze","G","R","B"],
    ["Turtle Van","C","R","B"],
    ["Baxter Stockman","U","U","B"],
    ["Go Ninja, Go!","B","U","B"],
    ["Karai, Future of the Foot","B","R","B"],
    ["Mikey & Leo, Chaos & Order","M","R","B"],
    ["Pizza Face, Gastromancer","W","R","B"],
    ["Leonardo, Cutting Edge","W","U","B-"],
    ["Lita, Little Orphan Amphibian","G","U","B-"],
    ["Ray Fillet, Man Ray","U","U","B-"],
    ["Shredder's Technique","B","U","B-"],
    ["Splinter, Hamato Yoshi","W","M","B-"],
    ["Casey Jones, Vigilante","R","U","B-"],
    ["Improvised Arsenal","C","U","B-"],
    ["Raphael, the Nightwatcher","R","R","B-"],
    ["Novel Nunchaku","C","U","B-"],
    ["Chrome Dome","C","R","B-"],
    ["Henchbots","C","C","B-"],
    ["Dark Leo & Shredder","M","R","B-"],
    ["Don & Leo, Problem Solvers","M","U","B-"],
    ["Genghis Frog","G","U","B-"],
    ["Tainted Treats","B","U","B-"],
    ["The Last Ronin's Technique","B","U","C+"],
    ["Buzz Bots","C","C","C+"],
    ["Donatello, Mutant Mechanic","U","U","C+"],
    ["Donatello, Turtle Techie","U","R","C+"],
    ["Mondo Gecko","G","C","C+"],
    ["Return to the Sewers","G","U","C+"],
    ["Anchovy & Banana Pizza","C","C","C+"],
    ["Death in the Family","B","U","C+"],
    ["Lord Dregg, Insect Invader","R","R","C+"],
    ["Ninja Teen","B","C","C+"],
    ["Stomped by the Foot","W","C","C+"],
    ["Casey Jones, Jury-Rig Justiciar","R","U","C+"],
    ["Manhole Missile","R","C","C+"],
    ["Michelangelo, Mutant BFF","G","U","C+"],
    ["Primordial Pachyderm","G","U","C+"],
    ["West Wind Avatar","W","U","C+"],
    ["Technodrome","C","R","C+"],
    ["Weather Maker","U","U","C+"],
    ["Lessons from Life","W","U","C+"],
    ["Mikey & Don, Party Planners","M","U","C+"],
    ["Dimension X","L","R","C+"],
    ["Escape Tunnel","L","C","C+"],
    ["Foot Headquarters","L","U","C+"],
    ["Illegitimate Business","B","C","C+"],
    ["Mutant Town","L","U","C+"],
    ["TCRI Building","L","U","C+"],
    ["Sword of Sinew and Steel","C","M","C+"],
    ["April O'Neil, Kunoichi Trainee","W","U","C"],
    ["Leonardo, Big Brother","W","U","C"],
    ["Leonardo, Leader in Blue","W","R","C"],
    ["Uneasy Alliance","U","C","C"],
    ["Bespoke B≈ç","C","U","C"],
    ["Donatello, Gadget Master","U","U","C"],
    ["Donatello's Technique","U","C","C"],
    ["Fugitive Droid","C","C","C"],
    ["Ooze Spill","G","C","C"],
    ["Retro-Mutation","G","C","C"],
    ["Bot Bashing Time","R","C","C"],
    ["Mouser Foundry","C","U","C"],
    ["Foot Mystic","B","C","C"],
    ["Madame Null, Power Broker","B","R","C"],
    ["Paramecia Coloniex","G","U","C"],
    ["Krang, Utrom Warlord","U","U","C"],
    ["Turtle Blimp","C","U","C"],
    ["Frog Butler","G","C","C"],
    ["Guac & Marshmallow Pizza","C","C","C"],
    ["Party Dude","G","C","C"],
    ["Ragamuffin Raptor","G","C","C"],
    ["Tenderize","R","C","C"],
    ["Turtle Lair","L","U","C"],
    ["Bebop & Rocksteady","R","R","C"],
    ["Don & Raph, Hard Science","M","U","C"],
    ["Foot Ninjas","B","C","C"],
    ["The Neutrinos","U","R","C"],
    ["Raph & Leo, Sibling Rivals","M","U","C"],
    ["Splinter, Radical Rat","W","U","C"],
    ["Tokka & Rahzar, Terrible Twos","M","U","C"],
    ["Cytoplast Manipulator","U","R","C"],
    ["Featherbrained Filcher","B","C","C-"],
    ["Jennika, Bad Apple Big Sister","W","R","C-"],
    ["Koya, Death from Above","B","R","C-"],
    ["Make Your Move","R","C","C-"],
    ["Sewer-veillance Cam","C","C","C-"],
    ["Dream Beavers","U","R","C-"],
    ["Oroku Saki, Shredder Rising","B","U","C-"],
    ["South Wind Avatar","G","U","C-"],
    ["Squirrelanoids","G","C","C-"],
    ["Old Hob, Alleycat Blues","B","U","C-"],
    ["Purple Dragon Punks","R","C","C-"],
    ["Wingnut, Bat on the Belfry","W","U","C-"],
    ["Cowabunga!","R","C","C-"],
    ["Turtle Power!","W","C","C-"],
    ["Mechanized Ninja Cavalry","W","R","C-"],
    ["Slithering Cryptid","B","C","C-"],
    ["Brainstorm","U","M","C-"],
    ["Ashcoat of the Shadow Swarm","B","M","C-"],
    ["Metallic Mimic","C","R","C-"],
    ["Action News Crew","W","C","D+"],
    ["Grounded for Life","W","C","D+"],
    ["High-Flying Ace","U","C","D+"],
    ["Leonardo's Technique","W","C","D+"],
    ["Prehistoric Pet","G","C","D+"],
    ["Quintessential Katana","C","U","D+"],
    ["April, Reporter of the Weird","W","U","D+"],
    ["Crustacean Commando","U","C","D+"],
    ["Kitsune, Dragon's Daughter","W","R","D+"],
    ["Mind Transfer Protocol","U","U","D+"],
    ["Utrom Scientists","U","C","D+"],
    ["Cool but Rude","R","C","D+"],
    ["Jennika's Technique","W","C","D+"],
    ["Mouser Attack!","C","C","D+"],
    ["Mutant Town Musicians","G","C","D+"],
    ["Null Group Biological Assets","W","U","D+"],
    ["Raphael, Most Attitude","R","U","D+"],
    ["Raphael, Ninja Destroyer","R","R","D+"],
    ["Raphael, Tough Turtle","R","U","D+"],
    ["Insectoid Exterminator","B","C","D+"],
    ["Pain 101","R","C","D+"],
    ["Shredder, Unrelenting","B","M","D+"],
    ["Shredder's Revenge","R","U","D+"],
    ["Tunnel Rats","B","C","D+"],
    ["Michelangelo, Game Master","G","U","D+"],
    ["Saved by the Shell","W","C","D+"],
    ["Transdimensional Bovine","W","C","D+"],
    ["Venus, Torn Between Worlds","U","R","D+"],
    ["Zoo Escapees","G","C","D+"],
    ["Everything Pizza","C","U","D+"],
    ["Omni-Cheese Pizza","C","C","D+"],
    ["Skateboard","C","U","D+"],
    ["Foot Elite","B","C","D+"],
    ["Ice Cream Kitty","W","C","D+"],
    ["Mouser Mark III","C","C","D+"],
    ["Nobody","B","U","D+"],
    ["Punk Frogs","G","C","D+"],
    ["Putrid Pals","B","C","D+"],
    ["Northampton Farm","L","C","D+"],
    ["East Wind Avatar","R","U","D"],
    ["Hamato Guardian Stance","W","C","D"],
    ["Donatello, Way with Machines","U","U","D"],
    ["Stockman, Mad Fly-entist","U","R","D"],
    ["Shredder's Armor","C","R","D"],
    ["Splinter's Technique","W","C","D"],
    ["Hard-Won Jitte","C","U","D"],
    ["Zog, Triceraton Castaway","R","U","D"],
    ["Mona Lisa, Science Geek","G","R","D"],
    ["Mutant Chain Reaction","G","U","D"],
    ["New Generation's Technique","G","C","D"],
    ["Rocksteady, Crash Courser","R","U","D"],
    ["Teleportation Circle","W","R","D"],
    ["Negate","U","C","D"],
    ["Trouble in Pairs","U","C","D"],
    ["Conqueror's Flail","C","R","D"],
    ["Rhythm of the Wild","M","R","D"],
    ["EPF Point Squad","W","C","D"],
    ["Bebop, Warthog Warrior","R","R","D-"],
    ["Rock Soldiers","R","C","D-"],
    ["Michelangelo's Technique","G","C","D-"],
    ["All Will Be One","R","M","D-"],
    ["Silverclad Ferocidons","R","R","D-"],
    ["Undercity Sewers","L","C","D-"],
    ["Turtles Forever","M","M","F"],
    ["Kitsune's Technique","W","C","F"],
    ["Turtles in Time","U","M","F"],
    ["Broadcast Takeover","U","R","F"],
    ["Raphael's Technique","R","C","F"],
    ["Underworld Breach","B","M","F"],
    ["Plague of Vermin","B","R","F"],
    ["Doubling Season","G","M","F"],
    ["Waves of Aggression","R","R","F"],
    // Bonus sheet/reprints not in CGB list (will be DS-only)
    ["Path to Exile","W","R",null],
    ["Arcbound Ravager","C","M",null],
];

// Draftsim scores (0-10, extracted from saved review page)
const DS_SCORES = {
    "Action News Crew": 3,
    "Agent Bishop, Man in Black": 10,
    "April O'Neil, Kunoichi Trainee": 4,
    "Dimensional Exile": 7,
    "East Wind Avatar": 3,
    "Featherbrained Filcher": 5,
    "Grounded for Life": 4,
    "Hamato Guardian Stance": 1,
    "High-Flying Ace": 4,
    "Jennika, Bad Apple Big Sister": 3,
    "Koya, Death from Above": 7,
    "The Last Ronin's Technique": 5,
    "Leader's Talent": 6,
    "Leonardo, Big Brother": 2,
    "Leonardo, Cutting Edge": 7,
    "Leonardo, Leader in Blue": 7,
    "Leonardo, Sewer Samurai": 9,
    "Leonardo's Technique": 2,
    "Lita, Little Orphan Amphibian": 6,
    "Make Your Move": 2,
    "Mighty Mutanimals": 6,
    "Prehistoric Pet": 4,
    "Quintessential Katana": 3,
    "Sally Pride, Lioness Leader": 10,
    "Triceraton Commander": 9,
    "Turncoat Kunoichi": 10,
    "Turtles Forever": 2,
    "Uneasy Alliance": 5,
    "April O'Neil, Hacktivist": 8,
    "April, Reporter of the Weird": 5,
    "Bespoke B≈ç": 5,
    "Buzz Bots": 4,
    "Crustacean Commando": 2,
    "Does Machines": 8,
    "Donatello, Gadget Master": 6,
    "Donatello, Mutant Mechanic": 7,
    "Donatello, Turtle Techie": 4,
    "Donatello, Way with Machines": 5,
    "Donatello's Technique": 6,
    "Fugitive Droid": 6,
    "Kitsune, Dragon's Daughter": 9,
    "Kitsune's Technique": 0,
    "Krang, Master Mind": 10,
    "Metalhead": 7,
    "Mind Transfer Protocol": 5,
    "Mondo Gecko": 4,
    "Negate": 1,
    "Ooze Spill": 1,
    "Ray Fillet, Man Ray": 6,
    "Renet, Temporal Apprentice": 5,
    "Retro-Mutation": 4,
    "Return to the Sewers": 4,
    "Sewer-veillance Cam": 1,
    "Stockman, Mad Fly-entist": 2,
    "Turtles in Time": 8,
    "Utrom Scientists": 5,
    "Anchovy & Banana Pizza": 6,
    "Armaggon, Future Shark": 8,
    "Bebop, Warthog Warrior": 2,
    "The Cloning of Shredder": 8,
    "Death in the Family": 5,
    "Dream Beavers": 7,
    "Foot Mystic": 3,
    "Insectoid Exterminator": 2,
    "Lord Dregg, Insect Invader": 7,
    "Madame Null, Power Broker": 7,
    "Ninja Teen": 6,
    "Oroku Saki, Shredder Rising": 4,
    "Pain 101": 2,
    "Paramecia Coloniex": 3,
    "Rat King, Verminister": 8,
    "Savanti Romero, Time's Exile": 8,
    "Shark Shredder, Killer Clone": 9,
    "Shredder, Unrelenting": 6,
    "Shredder's Armor": 5,
    "Shredder's Revenge": 1,
    "Shredder's Technique": 6,
    "South Wind Avatar": 5,
    "Splinter, Hamato Yoshi": 7,
    "Splinter's Technique": 1,
    "Squirrelanoids": 4,
    "Stomped by the Foot": 6,
    "Super Shredder": 6,
    "Tunnel Rats": 1,
    "Bot Bashing Time": 5,
    "Broadcast Takeover": 0,
    "Casey Jones, Jury-Rig Justiciar": 5,
    "Casey Jones, Vigilante": 1,
    "Cool but Rude": 0,
    "General Traag, Heart of Stone": 7,
    "Hard-Won Jitte": 1,
    "Improvised Arsenal": 7,
    "Jennika's Technique": 2,
    "Manhole Missile": 6,
    "Mouser Attack!": 2,
    "Mouser Foundry": 3,
    "Mutant Town Musicians": 3,
    "Null Group Biological Assets": 2,
    "Old Hob, Alleycat Blues": 6,
    "Purple Dragon Punks": 4,
    "Raphael, Most Attitude": 4,
    "Raphael, Ninja Destroyer": 4,
    "Raphael, the Nightwatcher": 6,
    "Raphael, Tough Turtle": 3,
    "Raphael's Technique": 1,
    "Ravenous Robots": 6,
    "Rock Soldiers": 3,
    "Slash, Reptile Rampager": 7,
    "Spicy Oatmeal Pizza": 7,
    "Wingnut, Bat on the Belfry": 4,
    "Zog, Triceraton Castaway": 3,
    "Courier of Comestibles": 6,
    "Cowabunga!": 2,
    "Frog Butler": 5,
    "Groundchuck & Dirtbag": 3,
    "Guac & Marshmallow Pizza": 2,
    "Leatherhead, Swamp Stalker": 7,
    "Michelangelo, Game Master": 4,
    "Michelangelo, Improviser": 4,
    "Michelangelo, Mutant BFF": 6,
    "Michelangelo, Weirdness to 11": 8,
    "Michelangelo's Technique": 4,
    "Mona Lisa, Science Geek": 3,
    "Mutagen Man, Living Ooze": 7,
    "Mutant Chain Reaction": 1,
    "New Generation's Technique": 5,
    "Novel Nunchaku": 6,
    "Party Dude": 1,
    "Primordial Pachyderm": 3,
    "Ragamuffin Raptor": 6,
    "Rocksteady, Crash Courser": 3,
    "Saved by the Shell": 4,
    "Tenderize": 6,
    "Transdimensional Bovine": 6,
    "Turtle Power!": 3,
    "Venus, Torn Between Worlds": 4,
    "West Wind Avatar": 6,
    "Zoo Escapees": 3,
    "Baxter Stockman": 5,
    "Bebop & Rocksteady": 6,
    "Brilliance Unleashed": 7,
    "Dark Leo & Shredder": 8,
    "Don & Leo, Problem Solvers": 4,
    "Don & Raph, Hard Science": 4,
    "EPF Point Squad": 3,
    "Foot Elite": 2,
    "Foot Ninjas": 3,
    "Genghis Frog": 6,
    "Go Ninja, Go!": 6,
    "Ice Cream Kitty": 4,
    "Karai, Future of the Foot": 7,
    "Karai's Technique": 8,
    "Krang & Shredder": 9,
    "The Last Ronin": 10,
    "Lessons from Life": 6,
    "Mechanized Ninja Cavalry": 5,
    "Mikey & Don, Party Planners": 5,
    "Mikey & Leo, Chaos & Order": 7,
    "Mouser Mark III": 3,
    "The Neutrinos": 7,
    "Nobody": 3,
    "North Wind Avatar": 9,
    "Pizza Face, Gastromancer": 7,
    "Punk Frogs": 1,
    "Putrid Pals": 3,
    "Raph & Leo, Sibling Rivals": 7,
    "Raph & Mikey, Troublemakers": 9,
    "Slithering Cryptid": 3,
    "Splinter, Radical Rat": 6,
    "Tainted Treats": 7,
    "Tokka & Rahzar, Terrible Twos": 4,
    "Chrome Dome": 4,
    "Everything Pizza": 3,
    "Henchbots": 6,
    "Krang, Utrom Warlord": 1,
    "Omni-Cheese Pizza": 3,
    "The Ooze": 7,
    "Skateboard": 1,
    "Technodrome": 6,
    "Turtle Blimp": 5,
    "Turtle Van": 7,
    "Weather Maker": 4,
    "TCRI Building": 4,
    "Escape Tunnel": 4,
    "Northampton Farm": 1,
    "Turtle Lair": 5,
    "Path to Exile": 8,
    "Brainstorm": 3,
    "Cytoplast Manipulator": 7,
    "Arcbound Ravager": 7,
    "Conqueror's Flail": 5,
    "Metallic Mimic": 6,
    "Shadowspear": 7,
    "Sword of Sinew and Steel": 7,
    "Umezawa's Jitte": 11,
    "Undercity Sewers": 4,
    // DS-only (not in CGB)
    "All Will Be One": 1,        // CGB D-
    "Ashcoat of the Shadow Swarm": 2, // CGB C-
    "Bebop & Rocksteady": 6,
    "Doubling Season": 1,
    "Plague of Vermin": 2,
    "Rhythm of the Wild": 3,
    "Silverclad Ferocidons": 2,
    "Teleportation Circle": 3,
    "Trouble in Pairs": 2,
    "Underworld Breach": 1,
    "Waves of Aggression": 2,
};

// MTG Arena Zone scores (limited format out of 10)
const MAZ_SCORES = {
    "Action News Crew": 3, "Agent Bishop, Man in Black": 8, "April O'Neil, Kunoichi Trainee": 4, "Dimensional Exile": 7,
    "East Wind Avatar": 4, "Featherbrained Filcher": 6, "Grounded for Life": 5, "Hamato Guardian Stance": 3,
    "High-Flying Ace": 4, "Jennika, Bad Apple Big Sister": 4, "Koya, Death from Above": 5, "The Last Ronin's Technique": 5,
    "Leader's Talent": 5, "Leonardo, Big Brother": 4, "Leonardo, Cutting Edge": 4, "Leonardo, Leader in Blue": 5,
    "Leonardo, Sewer Samurai": 6, "Leonardo's Technique": 3, "Lita, Little Orphan Amphibian": 5, "Mighty Mutanimals": 6,
    "Prehistoric Pet": 6, "Quintessential Katana": 5, "Sally Pride, Lioness Leader": 8, "Triceraton Commander": 7,
    "Turncoat Kunoichi": 7, "Turtles Forever": 2, "Uneasy Alliance": 5, "April O'Neil, Hacktivist": 7,
    "April, Reporter of the Weird": 4, "Bespoke B≈ç": 4, "Buzz Bots": 4, "Crustacean Commando": 2,
    "Does Machines": 8, "Donatello, Gadget Master": 6, "Donatello, Mutant Mechanic": 7, "Donatello, Turtle Techie": 4,
    "Donatello, Way with Machines": 5, "Donatello's Technique": 6, "Fugitive Droid": 6, "Kitsune, Dragon's Daughter": 9,
    "Kitsune's Technique": 0, "Krang, Master Mind": 10, "Metalhead": 7, "Mind Transfer Protocol": 5,
    "Mondo Gecko": 4, "Negate": 1, "Ooze Spill": 1, "Ray Fillet, Man Ray": 6,
    "Renet, Temporal Apprentice": 5, "Retro-Mutation": 4, "Return to the Sewers": 4, "Sewer-veillance Cam": 1,
    "Stockman, Mad Fly-entist": 2, "Turtles in Time": 8, "Utrom Scientists": 5
};

// ‚îÄ‚îÄ Grade ‚Üí numeric conversion ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GRADE_TO_NUM = {
    'A+': 10, 'A': 9, 'A-': 8.5,
    'B+': 7.5, 'B': 6.5, 'B-': 5.5,
    'C+': 4.5, 'C': 3.5, 'C-': 2.5,
    'D+': 1.5, 'D': 1.0, 'D-': 0.5,
    'F': 0
};

// ‚îÄ‚îÄ Build unified card list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildCards() {
    const map = {};

    // Load CGB data
    CGB_DATA.forEach(([name, color, rarity, grade]) => {
        map[name] = { name, color, rarity, cgb_grade: grade, cgb_num: grade ? GRADE_TO_NUM[grade] : null, ds_raw: null, maz_raw: null };
    });

    // Load Draftsim data ‚Äî merge or add
    Object.entries(DS_SCORES).forEach(([name, score]) => {
        if (!map[name]) {
            // DS-only card ‚Äî need color/rarity from CGB or guess unknown
            map[name] = { name, color: '?', rarity: '?', cgb_grade: null, cgb_num: null, ds_raw: score, maz_raw: null };
        } else {
            map[name].ds_raw = score;
        }
    });

    // Load MTG Arena Zone data ‚Äî merge or add
    Object.entries(MAZ_SCORES).forEach(([name, score]) => {
        if (!map[name]) {
            // MAZ-only card
            map[name] = { name, color: '?', rarity: '?', cgb_grade: null, cgb_num: null, ds_raw: null, maz_raw: score };
        } else {
            map[name].maz_raw = score;
        }
    });

    // Also patch missing CGB entries for DS-only cards with known metadata
    const DS_META = {
        "All Will Be One": ["R","M"],
        "Ashcoat of the Shadow Swarm": ["B","M"],
        "Doubling Season": ["G","M"],
        "Plague of Vermin": ["B","R"],
        "Rhythm of the Wild": ["M","R"],
        "Silverclad Ferocidons": ["R","R"],
        "Teleportation Circle": ["W","R"],
        "Trouble in Pairs": ["U","C"],
        "Underworld Breach": ["B","M"],
        "Waves of Aggression": ["R","R"],
        "Path to Exile": ["W","R"],
        "Arcbound Ravager": ["C","M"],
    };
    Object.entries(DS_META).forEach(([name, [color, rarity]]) => {
        if (map[name]) { map[name].color = color; map[name].rarity = rarity; }
    });

    return Object.values(map);
}

// ‚îÄ‚îÄ Z-score normalization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function zScore(vals) {
    const valid = vals.filter(v => v !== null && v !== undefined);
    if (valid.length < 2) return vals.map(() => null);
    const mean = valid.reduce((a, b) => a + b, 0) / valid.length;
    const sd = Math.sqrt(valid.reduce((a, b) => a + (b - mean) ** 2, 0) / valid.length);
    if (sd === 0) return vals.map(v => v === null ? null : 0);
    return vals.map(v => v === null ? null : (v - mean) / sd);
}

const RAW_CARDS = buildCards();

// Compute z-scores for each source
const cgb_nums = RAW_CARDS.map(c => c.cgb_num);
const cgb_zs = zScore(cgb_nums);

const ds_raws = RAW_CARDS.map(c => c.ds_raw);
const ds_zs = zScore(ds_raws);

const maz_raws = RAW_CARDS.map(c => c.maz_raw);
const maz_zs = zScore(maz_raws);

// Attach and compute avg + controversy
const CARDS = RAW_CARDS.map((c, i) => {
    const cgb_z = cgb_zs[i];
    const ds_z = ds_zs[i];
    const maz_z = maz_zs[i];
    const available = [cgb_z, ds_z, maz_z].filter(v => v !== null);
    const avg_z = available.length > 0 ? available.reduce((a, b) => a + b, 0) / available.length : null;
    // Controversy = max z-score spread (highest - lowest of available scores)
    const zscores_present = [cgb_z, ds_z, maz_z].filter(v => v !== null);
    const controversy = zscores_present.length > 1
        ? Math.max(...zscores_present) - Math.min(...zscores_present)
        : null;
    return { ...c, cgb_z, ds_z, maz_z, avg_z, controversy, sources: available.length, type: null, mana: null };
});

// ‚îÄ‚îÄ Filter/sort state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COLOR_ORDER = { 'W':0,'U':1,'B':2,'R':3,'G':4,'M':5,'C':6,'L':7,'?':8 };
const RARITY_ORDER = { 'M':0,'R':1,'U':2,'C':3,'L':4,'?':5 };
const GRADE_ORDER = { 'A+':0,'A':1,'A-':2,'B+':3,'B':4,'B-':5,'C+':6,'C':7,'C-':8,'D+':9,'D':10,'D-':11,'F':12 };

let activeColors = new Set(['W','U','B','R','G','M','C','L','?']);
let activeRarities = new Set(['M','R','U','C','L','?']);
let currentSort = 'avg_z';
let sortAsc = false;
let currentSearch = '';

// ‚îÄ‚îÄ Scryfall card data cache ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const scryfallCache = new Map(); // name ‚Üí {imageUrl, type, mana_cost}

function fetchCardData(name) {
    if (scryfallCache.has(name)) return Promise.resolve(scryfallCache.get(name));
    return fetch(`https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`)
        .then(r => r.ok ? r.json() : null)
        .then(card => {
            if (!card) { scryfallCache.set(name, null); return null; }
            // Handle double-faced cards (image in card_faces)
            let imageUrl = null;
            if (card.image_uris) {
                imageUrl = card.image_uris.normal || card.image_uris.large || null;
            } else if (card.card_faces && card.card_faces[0].image_uris) {
                imageUrl = card.card_faces[0].image_uris.normal || null;
            }
            const typeLine = card.type_line || null;
            const manaCost = card.mana_cost || (card.card_faces && card.card_faces[0].mana_cost) || null;
            const data = { imageUrl, type: typeLine, mana: manaCost };
            scryfallCache.set(name, data);
            return data;
        })
        .catch(() => { scryfallCache.set(name, null); return null; });
}

// Prefetch all card data in background (rate-limited to ~80ms apart)
function prefetchAll() {
    let idx = 0;
    function next() {
        if (idx >= CARDS.length) return;
        const card = CARDS[idx++];
        fetchCardData(card.name).then(data => {
            if (data) {
                card.type = data.type;
                card.mana = data.mana;
            }
        });
        setTimeout(next, 80);
    }
    setTimeout(next, 300);
}

// ‚îÄ‚îÄ Card image tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let activeHoverName = null;

function showCardTooltip(e) {
    const name = e.currentTarget.dataset.name;
    if (!name) return;
    activeHoverName = name;
    const tooltip = document.getElementById('cardTooltip');
    fetchCardData(name).then(data => {
        if (activeHoverName !== name || !data || !data.imageUrl) return;
        tooltip.innerHTML = `<img src="${data.imageUrl}" alt="${name}" loading="lazy">`;
        tooltip.style.display = 'block';
        positionTooltip(e.currentTarget);
    });
}

function hideCardTooltip() {
    activeHoverName = null;
    document.getElementById('cardTooltip').style.display = 'none';
}

function positionTooltip(anchor) {
    const tooltip = document.getElementById('cardTooltip');
    if (tooltip.style.display === 'none') return;
    const rect = anchor.getBoundingClientRect();
    const margin = 10;
    const tw = tooltip.offsetWidth || 230;
    const th = tooltip.offsetHeight || 320;
    let left = rect.left;
    if (left + tw > window.innerWidth - margin) left = window.innerWidth - margin - tw;
    if (left < margin) left = margin;
    let top = rect.top - th - margin;
    if (top < margin) top = rect.bottom + margin;
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
}

// ‚îÄ‚îÄ Inline image toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleInlineImages(on) {
    if (on) {
        document.body.classList.add('show-images');
        ensureAllRowImages();
    } else {
        document.body.classList.remove('show-images');
    }
}

function ensureAllRowImages() {
    document.querySelectorAll('#tableBody tr').forEach(row => {
        const name = row.dataset.name;
        if (!name) return;
        const cell = row.querySelector('td.name-col');
        if (!cell) return;
        let imgDiv = cell.querySelector('.card-image');
        if (!imgDiv) {
            imgDiv = document.createElement('div');
            imgDiv.className = 'card-image';
            cell.appendChild(imgDiv);
        }
        if (imgDiv.dataset.loaded === 'true') return;
        imgDiv.dataset.loaded = 'pending';
        fetchCardData(name).then(data => {
            if (!data || !data.imageUrl) return;
            imgDiv.innerHTML = `<img src="${data.imageUrl}" alt="${name}" loading="lazy">`;
            imgDiv.dataset.loaded = 'true';
        });
    });
}

// ‚îÄ‚îÄ Rendering helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function fmtZ(z) {
    if (z === null || z === undefined) return '<span class="missing">‚Äî</span>';
    return (z >= 0 ? '+' : '') + z.toFixed(2);
}

function barColor(z) {
    if (z === null) return '#e5e7eb';
    if (z >= 1.5) return '#16a34a';
    if (z >= 0.5) return '#65a30d';
    if (z >= 0) return '#ca8a04';
    if (z >= -0.5) return '#ea580c';
    return '#dc2626';
}

function barWidth(z) {
    if (z === null) return 0;
    return Math.max(0, Math.min(100, ((z + 3) / 6) * 100));
}

function colorBadge(color) {
    const labels = { W:'W',U:'U',B:'B',R:'R',G:'G',M:'Multi',C:'Art',L:'Land','?':'?' };
    return `<span class="color-badge color-${color}">${labels[color]||color}</span>`;
}

function rarityDisplay(r) {
    return `<span class="rarity-${r}">${r}</span>`;
}

function cgbClass(grade) {
    if (!grade) return '';
    return 'cgb-' + grade.replace('+','plus').replace('-','minus');
}

function dsColor(score) {
    if (score === null) return '#9ca3af';
    if (score >= 9) return '#166534';
    if (score >= 7) return '#2d6a4f';
    if (score >= 5) return '#854d0e';
    if (score >= 3) return '#9a3412';
    return '#6b7280';
}

function controversyClass(v) {
    if (v === null) return '';
    if (v < 0.75) return 'controversy-low';
    if (v < 1.5) return 'controversy-mid';
    return 'controversy-high';
}

function scryfallUrl(name) {
    return `https://scryfall.com/search?q=${encodeURIComponent('"' + name + '" set:tmt')}`;
}

// Abbreviate type line for compact display
function abbrevType(t) {
    if (!t) return '‚Ä¶';
    return t
        .replace('Legendary ', 'L. ')
        .replace('Artifact Creature', 'Art. Creature')
        .replace('Enchantment Creature', 'Enc. Creature')
        .replace('Planeswalker', 'PW')
        .replace('Instant', 'Inst')
        .replace('Sorcery', 'Sorc')
        .replace('Artifact', 'Art')
        .replace('Enchantment', 'Ench')
        .replace('Land', 'Land');
}

// Render mana cost string as colored text shorthand
function fmtMana(m) {
    if (!m) return '<span class="missing">‚Ä¶</span>';
    // Convert {2}{W}{U} etc. to a compact display
    return m.replace(/\{([^}]+)\}/g, (_, sym) => {
        const s = sym.toUpperCase();
        const colorMap = { W:'#c8aa6e', U:'#5080a0', B:'#333', R:'#d43f1c', G:'#2d6a4f' };
        const col = colorMap[s];
        if (col) return `<span style="font-weight:700;color:${col}">${sym}</span>`;
        return `<span style="color:#555">${sym}</span>`;
    });
}

function renderTable() {
    let data = CARDS.filter(c => {
        if (!activeColors.has(c.color)) return false;
        if (!activeRarities.has(c.rarity)) return false;
        if (currentSearch && !c.name.toLowerCase().includes(currentSearch.toLowerCase())) return false;
        return true;
    });

    data.sort((a, b) => {
        let diff = 0;
        if (currentSort === 'avg_z') {
            diff = (a.avg_z ?? -999) - (b.avg_z ?? -999);
        } else if (currentSort === 'cgb_raw') {
            const ag = a.cgb_grade ? GRADE_ORDER[a.cgb_grade] ?? 99 : 99;
            const bg = b.cgb_grade ? GRADE_ORDER[b.cgb_grade] ?? 99 : 99;
            diff = ag - bg;
        } else if (currentSort === 'cgb_z') {
            diff = (a.cgb_z ?? -999) - (b.cgb_z ?? -999);
        } else if (currentSort === 'ds_raw') {
            diff = (a.ds_raw ?? -1) - (b.ds_raw ?? -1);
        } else if (currentSort === 'ds_z') {
            diff = (a.ds_z ?? -999) - (b.ds_z ?? -999);
        } else if (currentSort === 'maz_raw') {
            diff = (a.maz_raw ?? -1) - (b.maz_raw ?? -1);
        } else if (currentSort === 'maz_z') {
            diff = (a.maz_z ?? -999) - (b.maz_z ?? -999);
        } else if (currentSort === 'controversy') {
            diff = (a.controversy ?? -1) - (b.controversy ?? -1);
        } else if (currentSort === 'name') {
            diff = a.name.localeCompare(b.name);
        } else if (currentSort === 'color') {
            diff = (COLOR_ORDER[a.color]??99) - (COLOR_ORDER[b.color]??99);
        } else if (currentSort === 'rarity') {
            diff = (RARITY_ORDER[a.rarity]??99) - (RARITY_ORDER[b.rarity]??99);
        } else if (currentSort === 'type') {
            diff = (a.type||'zzz').localeCompare(b.type||'zzz');
        } else if (currentSort === 'mana') {
            diff = (a.mana||'zzz').localeCompare(b.mana||'zzz');
        }
        if (diff === 0) diff = (b.avg_z ?? -999) - (a.avg_z ?? -999);
        return sortAsc ? diff : -diff;
    });

    const tbody = document.getElementById('tableBody');
    const noResults = document.getElementById('noResults');
    const table = document.getElementById('ratingsTable');
    const statsBar = document.getElementById('statsBar');
    const showImages = document.body.classList.contains('show-images');

    if (data.length === 0) {
        tbody.innerHTML = '';
        noResults.style.display = 'block';
        table.style.display = 'none';
    } else {
        noResults.style.display = 'none';
        table.style.display = '';

        tbody.innerHTML = data.map(c => {
            const cgbCell = c.cgb_grade
                ? `<span class="${cgbClass(c.cgb_grade)}">${c.cgb_grade}</span>`
                : '<span class="missing">‚Äî</span>';
            const cgbZCell = fmtZ(c.cgb_z);
            const dsCell = c.ds_raw !== null
                ? `<span class="ds-score" style="color:${dsColor(c.ds_raw)}">${c.ds_raw}/10</span>`
                : '<span class="missing">‚Äî</span>';
            const dsZCell = fmtZ(c.ds_z);
            const mazCell = c.maz_raw !== null
                ? `<span class="maz-score" style="color:${dsColor(c.maz_raw)}">${c.maz_raw}/10</span>`
                : '<span class="missing">‚Äî</span>';
            const mazZCell = fmtZ(c.maz_z);
            const sourcesLabel = c.sources === 1 ? ' (1 src)' : c.sources === 2 ? ' (2 src)' : '';

            const avgZ = c.avg_z;
            const barHtml = `<div class="norm-bar-wrap">
                <div class="norm-bar-bg"><div class="norm-bar-fill" style="width:${barWidth(avgZ)}%;background:${barColor(avgZ)}"></div></div>
                <span class="norm-val" style="color:${barColor(avgZ)}">${fmtZ(avgZ)}</span>
                <span class="missing" title="Sources">${sourcesLabel}</span>
            </div>`;

            const contCell = c.controversy !== null
                ? `<span class="${controversyClass(c.controversy)}">${c.controversy.toFixed(2)}</span>`
                : '<span class="missing">‚Äî</span>';

            // Inline image div (lazy ‚Äî populated when toggle is on)
            const imgDiv = showImages && scryfallCache.has(c.name) && scryfallCache.get(c.name)
                ? `<div class="card-image" data-loaded="true"><img src="${scryfallCache.get(c.name).imageUrl}" alt="${c.name}" loading="lazy"></div>`
                : `<div class="card-image" data-loaded="false"></div>`;

            return `<tr data-color="${c.color}" data-rarity="${c.rarity}" data-name="${c.name.replace(/"/g,'&quot;')}">
                <td class="name-col"><a class="name-link" href="${scryfallUrl(c.name)}" target="_blank" rel="noopener noreferrer" data-name="${c.name.replace(/"/g,'&quot;')}">${c.name}</a>${imgDiv}</td>
                <td>${colorBadge(c.color)}</td>
                <td>${rarityDisplay(c.rarity)}</td>
                <td class="type-cell" title="${c.type||'Loading‚Ä¶'}">${abbrevType(c.type)}</td>
                <td class="mana-cell">${fmtMana(c.mana)}</td>
                <td class="col-cgb">${cgbCell}</td>
                <td class="col-cgb">${cgbZCell}</td>
                <td class="col-ds">${dsCell}</td>
                <td class="col-ds">${dsZCell}</td>
                <td class="col-maz">${mazCell}</td>
                <td class="col-maz">${mazZCell}</td>
                <td class="col-avg norm-bar-cell">${barHtml}</td>
                <td class="col-controversy">${contCell}</td>
            </tr>`;
        }).join('');

        // Attach hover listeners after DOM update
        tbody.querySelectorAll('a.name-link').forEach(a => {
            a.addEventListener('mouseenter', showCardTooltip);
            a.addEventListener('mouseleave', hideCardTooltip);
        });

        // If show-images is on, load missing inline images
        if (showImages) ensureAllRowImages();
    }

    const src3 = CARDS.filter(c => c.sources === 3).length;
    const src2 = CARDS.filter(c => c.sources === 2).length;
    const src1 = CARDS.filter(c => c.sources === 1).length;
    statsBar.textContent = `Showing ${data.length} of ${CARDS.length} cards ¬∑ ` +
        `${src3} 3-source ¬∑ ${src2} 2-source ¬∑ ${src1} single-source`;
}

// ‚îÄ‚îÄ Controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleColor(btn) {
    const c = btn.dataset.color;
    if (activeColors.has(c)) { activeColors.delete(c); btn.classList.remove('active'); }
    else { activeColors.add(c); btn.classList.add('active'); }
    renderTable();
}

function allColors(on) {
    activeColors = on ? new Set(['W','U','B','R','G','M','C','L','?']) : new Set();
    document.querySelectorAll('.color-btn').forEach(b => {
        if (on) b.classList.add('active'); else b.classList.remove('active');
    });
    renderTable();
}

function toggleRarity(btn) {
    const r = btn.dataset.rarity;
    if (activeRarities.has(r)) { activeRarities.delete(r); btn.classList.remove('active'); }
    else { activeRarities.add(r); btn.classList.add('active'); }
    renderTable();
}

function sortBy(col) {
    if (currentSort === col) {
        sortAsc = !sortAsc;
    } else {
        currentSort = col;
        sortAsc = (col === 'name' || col === 'color' || col === 'rarity' || col === 'cgb_raw' || col === 'type' || col === 'mana' || col === 'maz_raw');
    }
    // Sync dropdown only for known options
    const sel = document.getElementById('sortSelect');
    if ([...sel.options].some(o => o.value === col)) sel.value = col;
    renderTable();
}

function applyFilters() {
    currentSort = document.getElementById('sortSelect').value;
    currentSearch = document.getElementById('searchInput').value;
    renderTable();
}

function resetFilters() {
    activeColors = new Set(['W','U','B','R','G','M','C','L','?']);
    activeRarities = new Set(['M','R','U','C','L','?']);
    currentSort = 'avg_z';
    sortAsc = false;
    currentSearch = '';
    document.getElementById('searchInput').value = '';
    document.getElementById('sortSelect').value = 'avg_z';
    document.querySelectorAll('.color-btn, .rarity-btn').forEach(b => b.classList.add('active'));
    renderTable();
}

// Initial render + prefetch
renderTable();
prefetchAll();

    </script>
</body>
</html>